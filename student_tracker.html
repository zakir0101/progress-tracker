<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Syllabus Student Progress Tracker</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1000px;
      margin: 20px auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .auth-section {
      background: #e7f3ff;
      padding: 20px;
      border-radius: 8px;
      margin: 20px auto;
      text-align: center;
      border-left: 4px solid #667eea;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .centered {
      margin: 0 auto;
    }

    .auth-section h3 {
      margin-bottom: 15px;
      color: #495057;
    }

    .user-info {
      background: #d4edda;
      padding: 15px 20px;
      border-radius: 8px;
      margin: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 4px solid #28a745;
    }

    .user-details {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #28a745;
    }

    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.2s ease;
    }

    .logout-btn:hover {
      background: #c82333;
    }

    .syllabus-selector {
      margin: 20px;
      padding: 15px;
      background-color: #f0f8ff;
      border: 1px solid #cceeff;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .syllabus-selector label {
      font-weight: bold;
      color: #0056b3;
      font-size: 1rem;
    }

    .syllabus-selector select {
      padding: 8px 12px;
      border: 1px solid #a0d3ff;
      border-radius: 5px;
      background-color: white;
      font-size: 0.95rem;
      flex-grow: 1;
      max-width: 300px;
      cursor: pointer;
      appearance: none;
      /* Remove default arrow */
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%20197.3l-11.4-11.4c-3.7-3.7-9.8-3.7-13.5%200l-127.3%20127.3c-3.7%203.7-9.8%203.7-13.5%200L16.4%20185.9c-3.7-3.7-9.8-3.7-13.5%200L1.9%20197.3c-3.7%203.7-3.7%209.8%200%2013.5l143.7%20143.7c3.7%203.7%209.8%203.7%2013.5%200l143.7-143.7c3.7-3.6%203.7-9.8%200-13.5z%22%2F%3E%3C%2Fsvg%3E');
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 12px;
    }


    .progress-container {
      background: #f8f9fa;
      padding: 20px;
      border-bottom: 1px solid #e9ecef;
      transition: all 0.3s ease;
      transform: translateY(0);
    }

    .progress-container.sticky {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(248, 249, 250, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      animation: slideDown 0.3s ease;
    }

    .progress-placeholder {
      height: 0;
      transition: height 0.3s ease;
    }

    .progress-placeholder.visible {
      height: 100px;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-100%);
      }

      to {
        transform: translateY(0);
      }
    }

    .syllabus-content {
      padding: 30px;
    }

    .progress-bar {
      background: #e9ecef;
      border-radius: 25px;
      height: 25px;
      margin: 10px 0;
      overflow: hidden;
    }

    .progress-fill {
      background: linear-gradient(90deg, #28a745, #20c997);
      height: 100%;
      border-radius: 25px;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .progress-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    .percentage {
      font-size: 2rem;
      font-weight: bold;
      color: #495057;
    }

    .count {
      color: #6c757d;
      font-size: 1rem;
    }

    .topic-section {
      margin-bottom: 30px;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      overflow: hidden;
    }

    .section-header {
      background: #495057;
      color: white;
      padding: 15px 20px;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-header:hover {
      background: #343a40;
    }

    .section-content {
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .section-content.expanded {
      padding: 20px;
      max-height: 2000px;
    }

    .topic-item {
      display: flex;
      align-items: flex-start;
      padding: 12px 0;
      border-bottom: 1px solid #f8f9fa;
    }

    .topic-item:last-child {
      border-bottom: none;
    }

    .topic-checkbox {
      margin-right: 15px;
      margin-top: 2px;
      transform: scale(1.2);
    }

    .topic-label {
      flex: 1;
      font-size: 1rem;
      line-height: 1.4;
    }

    .topic-label.completed {
      text-decoration: line-through;
      color: #6c757d;
    }

    .chapter-section {
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      overflow: hidden;
    }

    .chapter-header {
      background: #f8f9fa;
      padding: 12px 15px;
      font-weight: 600;
      color: #495057;
      border-bottom: 1px solid #e9ecef;
      font-size: 1.1rem;
    }

    .chapter-topics {
      padding: 10px 15px;
    }

    .submit-section {
      background: #f8f9fa;
      padding: 30px;
      text-align: center;
      border-top: 1px solid #e9ecef;
    }

    .submit-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 1.1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .submit-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .footer {
      background: #f8f9fa;
      padding: 20px;
      text-align: center;
      color: #6c757d;
      border-top: 1px solid #e9ecef;
    }

    .status-message {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      text-align: center;
      font-weight: 500;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 5px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .syllabus-content {
        padding: 15px;
      }

      .progress-container {
        padding: 15px;
      }

      .user-info {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }

      .syllabus-selector {
        flex-direction: column;
        gap: 10px;
      }

      .syllabus-selector select {
        width: 100%;
        max-width: none;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Student Progress Tracker</h1>
      <p>Multi-Syllabus Support</p>
    </div>

    <!-- Authentication Section -->
    <div class="auth-section" id="authSection">
      <h3>Sign in with Google to track your progress</h3>
      <div class="centered" id="g_id_onload"
        data-client_id="917775460589-0sb14a7k4rmbdf319evuober7ck655b7.apps.googleusercontent.com" data-context="signin"
        data-ux_mode="popup" data-callback="handleCredentialResponse" data-auto_prompt="false" data-itp_support="true">
      </div>
      <div class="g_id_signin centered" data-type="standard" data-shape="rectangular" data-theme="outline"
        data-text="signin_with" data-size="large" data-logo_alignment="left">
      </div>
      <p style="margin-top: 15px; font-size: 0.9rem; color: #6c757d;">
        <strong>Note:</strong> This tracker is served from the /tracker path on the main domain
      </p>
    </div>

    <!-- User Info Section -->

    <div class="user-info hidden" id="userInfo">
      <div class="user-details">
        <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
        <div>
          <strong id="userName"></strong>
          <div style="font-size: 0.9rem; color: #6c757d;">
            <span id="userEmail"></span>
          </div>
        </div>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <!-- Main Content (Hidden until authenticated) -->
    <div id="mainContent" class="hidden">

      <!-- Status Message -->
      <div id="statusMessage" class="status-message"></div>

      <!-- Syllabus Selector -->
      <div class="syllabus-selector">
        <label for="syllabusSelect">Select Syllabus:</label>
        <select id="syllabusSelect" onchange="loadUserProgressForSelectedSyllabus()"></select>
      </div>


      <div class="progress-container" id="progressContainer">
        <h3>Your Overall Progress <small>(Weighted by Topics)</small></h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
        </div>
        <div class="progress-stats">
          <div class="percentage" id="percentage">0%</div>
          <div class="count" id="progressCount">0/0 topics completed</div>
        </div>
        <div style="font-size: 0.8rem; color: #6c757d; margin-top: 5px;">
          Each topic contributes equally to overall progress
        </div>
      </div>
      <div class="progress-placeholder" id="progressPlaceholder"></div>

      <div class="syllabus-content">
        <!-- Syllabus sections will be dynamically generated -->
        <div id="syllabusContent"></div>

        <div class="submit-section" style="display: none;">
          <!-- Submit button removed - progress is saved automatically in real-time -->
        </div>
      </div>
    </div>

    <div class="footer">
      <p>Multi-Syllabus Student Progress Tracker</p>
      <p><small>Progress is automatically saved per user account and syllabus</small></p>
    </div>
  </div>

  <script>
    // Unified API Configuration for Flask Backend
    const API_CONFIG = {
      BASE_URL: '/tracker',
      SESSION_TIMEOUT: 60 * 60 * 1000 // 1 hour in milliseconds
    };

    // Global variables
    let currentUser = null;
    let sessionTimer = null;
    let currentSessionId = null;
    let availableSyllabuses = [];
    let selectedSyllabusId = null;

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function () {
      checkExistingSession();
      setupStickyAnimation();
    });

    // Check for existing user session
    function checkExistingSession() {
      const userSession = localStorage.getItem('igcse_user_session');

      if (userSession) {
        try {
          const session = JSON.parse(userSession);
          const now = Date.now();

          // Check if session is still valid
          if (session.expiresAt > now) {
            currentUser = session.user;
            showAuthenticatedUI();
            return;
          } else {
            // Session expired
            localStorage.removeItem('igcse_user_session');
            localStorage.removeItem('igcse_user_progress');
          }
        } catch (error) {
          console.error('Error parsing user session:', error);
          clearUserSession();
        }
      }

      showAuthenticationUI();
    }

    // Handle Google OAuth response
    function handleCredentialResponse(response) {
      console.log('Google OAuth response received:', response);

      if (!response || !response.credential) {
        console.error('Invalid OAuth response:', response);
        showStatus('Authentication failed: Invalid response from Google. Please try again.', 'error');
        return;
      }

      try {
        // Decode the JWT token to get user info
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        console.log('Decoded JWT payload:', payload);

        currentUser = {
          id: payload.sub,
          name: payload.name,
          email: payload.email,
          picture: payload.picture,
          loginTime: Date.now()
        };

        // Create session with expiration
        const session = {
          user: currentUser,
          expiresAt: Date.now() + API_CONFIG.SESSION_TIMEOUT
        };

        localStorage.setItem('igcse_user_session', JSON.stringify(session));

        // Initialize session with backend
        initializeBackendSession();

        showAuthenticatedUI();
        startSessionTimer();

        showStatus('Successfully signed in!', 'success');
      } catch (error) {
        console.error('Authentication error:', error);
        showStatus('Authentication failed: ' + error.message, 'error');
      }
    }

    // Initialize session with backend
    async function initializeBackendSession() {
      try {
        currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      } catch (error) {
        console.error('Session initialization error:', error);
      }
    }

    // Show authentication UI
    function showAuthenticationUI() {
      document.getElementById('authSection').classList.remove('hidden');
      document.getElementById('userInfo').classList.add('hidden');
      document.getElementById('mainContent').classList.add('hidden');
    }

    // Show authenticated UI
    async function showAuthenticatedUI() {
      if (!currentUser) return;

      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('userInfo').classList.remove('hidden');
      document.getElementById('mainContent').classList.remove('hidden');

      // Update user info
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userEmail').textContent = currentUser.email;
      document.getElementById('userAvatar').src = currentUser.picture;

      await loadAssignedSyllabuses();
    }

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to log out? Your progress will be saved.')) {
        clearUserSession();
        showAuthenticationUI();
        showStatus('Successfully logged out.', 'success');
      }
    }

    // Clear user session
    function clearUserSession() {
      currentUser = null;
      if (sessionTimer) {
        clearTimeout(sessionTimer);
        sessionTimer = null;
      }
      localStorage.removeItem('igcse_user_session');
    }

    // Start session timer
    function startSessionTimer() {
      if (sessionTimer) {
        clearTimeout(sessionTimer);
      }

      sessionTimer = setTimeout(() => {
        showStatus('Your session has expired. Please sign in again.', 'warning');
        clearUserSession();
        showAuthenticationUI();
      }, API_CONFIG.SESSION_TIMEOUT);
    }

    async function loadAssignedSyllabuses() {
      try {
        const params = new URLSearchParams({
          student_email: currentUser.email
        });
        const response = await fetch(`${API_CONFIG.BASE_URL}/student-syllabuses?${params}`, {
          method: "GET",
          headers: {
            "accept": "application/json"
          }
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const result = await response.json();
        if (result.success && result.syllabuses.length > 0) {
          availableSyllabuses = result.syllabuses;
          populateSyllabusSelector();
          // Select the first assigned syllabus by default
          selectedSyllabusId = availableSyllabuses[0].id;
          document.getElementById('syllabusSelect').value = selectedSyllabusId;
          loadSyllabusContent(selectedSyllabusId);
        } else {
          // If no syllabuses assigned, default to "contact" syllabus
          selectedSyllabusId = "contact";
          loadSyllabusContent(selectedSyllabusId);
          showStatus('No syllabuses assigned yet. Please contact your administrator to enroll in courses.', 'warning');
        }
      } catch (error) {
        console.error('Error loading assigned syllabuses:', error);
        showStatus('Failed to load assigned syllabuses. Please try again.', 'error');
        // Fallback to contact syllabus if API fails
        selectedSyllabusId = "contact";
        loadSyllabusContent(selectedSyllabusId);
      }
    }

    function populateSyllabusSelector() {
      const syllabusSelect = document.getElementById('syllabusSelect');
      syllabusSelect.innerHTML = ''; // Clear existing options

      availableSyllabuses.forEach(syllabus => {
        const option = document.createElement('option');
        option.value = syllabus.id;
        option.textContent = syllabus.name;
        syllabusSelect.appendChild(option);
      });
    }

    function loadUserProgressForSelectedSyllabus() {
      selectedSyllabusId = document.getElementById('syllabusSelect').value;
      loadSyllabusContent(selectedSyllabusId);
    }


    // Load syllabus content from Flask backend
    async function loadSyllabusContent(syllabusId) {
      try {
        const response = await fetch(`${API_CONFIG.BASE_URL}/syllabus/${syllabusId}`, {
          method: "GET",
          headers: {
            "accept": "application/json"
          }
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }


        const syllabusData = await response.json();
        console.log("Syllabus Data:", syllabusData);

        const syllabusContentDiv = document.getElementById('syllabusContent');
        syllabusContentDiv.innerHTML = '';

        if (!syllabusData.data || !syllabusData.data.variants) {
            syllabusContentDiv.innerHTML = '<p>No syllabus data available for this selection.</p>';
            return;
        }

        syllabusData.data.variants.forEach(variant => {
            const variantSection = document.createElement('div');
            variantSection.className = 'topic-section';

            // Group topics by chapter
            const chapters = {};
            variant.topics.forEach(topic => {
                if (!chapters[topic.chapter_name]) {
                    chapters[topic.chapter_name] = [];
                }
                chapters[topic.chapter_name].push(topic);
            });

            variantSection.innerHTML = `
                <div class="section-header" onclick="toggleSection(this)">
                    <span>${syllabusData.data.name} - ${variant.name}</span>
                    <span>▼</span>
                </div>
                <div class="section-content">
                    ${Object.entries(chapters).map(([chapterName, topics]) => `
                        <div class="chapter-section">
                            <div class="chapter-header">${chapterName}</div>
                            <div class="chapter-topics">
                                ${topics.map(topic => `
                                    <div class="topic-item">
                                        <input type="checkbox" class="topic-checkbox" id="${topic.id}" onchange="handleTopicChange(this)">
                                        <label class="topic-label" for="${topic.id}">${topic.topic_name}</label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            syllabusContentDiv.appendChild(variantSection);
        });

        // Expand all sections by default
        const sections = document.querySelectorAll('.section-content');
        sections.forEach(section => {
          section.classList.add('expanded');
          const header = section.previousElementSibling;
          header.querySelector('span:last-child').textContent = '▲';
        });

        // Load initial progress from backend for the selected syllabus
        loadInitialProgress(syllabusId);
      } catch (error) {
        console.error('Error loading syllabus:', error);
        showStatus('Failed to load syllabus data. Please try again.', 'error');
      }
    }

    // Load initial progress from backend
    async function loadInitialProgress(syllabusId) {
      if (!currentUser || !syllabusId) return;

      try {
        const params = new URLSearchParams({
          student_email: currentUser.email,
          syllabus_id: syllabusId
        });

        const response = await fetch(`${API_CONFIG.BASE_URL}/student-progress?${params}`, {
          headers: {
            'Accept': 'application/json'
          }
        });

        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            updateProgressFromBackend(result.progress);
            return;
          }
        }

        // If we get here, either the request failed or no progress data exists
        // Initialize with default progress (0% complete)
        initializeDefaultProgress(syllabusId);
      } catch (error) {
        console.error('Error loading initial progress:', error);
        // Initialize with default progress on error
        initializeDefaultProgress(syllabusId);
      }
    }

    // Initialize progress UI with default values (0% complete)
    function initializeDefaultProgress(syllabusId) {
      // Reset all checkboxes to unchecked
      const checkboxes = document.querySelectorAll('.topic-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        const label = checkbox.nextElementSibling;
        label.classList.remove('completed');
      });

      // Reset progress bar to 0%
      const progressFill = document.getElementById('progressFill');
      const percentageDisplay = document.getElementById('percentage');
      const progressCount = document.getElementById('progressCount');

      progressFill.style.width = '0%';
      progressFill.textContent = '0%';
      percentageDisplay.textContent = '0%';
      progressCount.textContent = '0/0 topics completed';
    }

    // Update progress UI with data from backend
    function updateProgressFromBackend(progressData) {
      if (!progressData) return;

      // Update checkboxes based on backend data for the current syllabus
      if (progressData.topics) {
        progressData.topics.forEach(topic => {
          const checkbox = document.getElementById(topic.id);
          if (checkbox) {
            checkbox.checked = topic.completed;
            const label = checkbox.nextElementSibling;
            if (topic.completed) {
              label.classList.add('completed');
            } else {
              label.classList.remove('completed');
            }
          }
        });
      }

      // Update progress bar and stats
      const progressFill = document.getElementById('progressFill');
      const percentageDisplay = document.getElementById('percentage');
      const progressCount = document.getElementById('progressCount');

      if (progressData.overall_progress) {
        const percentage = Math.round(progressData.overall_progress.percentage);
        progressFill.style.width = percentage + '%';
        progressFill.textContent = percentage + '%';
        percentageDisplay.textContent = percentage + '%';
        progressCount.textContent = progressData.overall_progress.completed + '/' + progressData.overall_progress.total + ' topics completed';
      }

      // Save progress to local storage (optional, as backend is authoritative)
      saveUserProgress();
    }

    // Toggle section expansion
    function toggleSection(header) {
      const content = header.nextElementSibling;
      const arrow = header.querySelector('span:last-child');

      if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        arrow.textContent = '▼';
      } else {
        content.classList.add('expanded');
        arrow.textContent = '▲';
      }
    }

    // Progress calculation is now handled entirely by the Flask backend
    // Frontend only displays data received from backend API calls

    // Handle checkbox change with real-time submission to Flask backend
    function handleTopicChange(checkbox) {
      // Get topic ID from checkbox ID
      const topicId = checkbox.id;
      const isCompleted = checkbox.checked;

      // Submit individual topic progress to Flask backend
      submitTopicProgress(selectedSyllabusId, topicId, isCompleted);
    }

    // Save user progress to local storage (simple placeholder for now, backend is source of truth)
    function saveUserProgress() {
      // No longer storing detailed topic progress in local storage
      // Only user session info is kept
    }

    // Load user progress from local storage (now loads only user session, not progress)
    function loadUserProgress() {
      // Logic for loading user progress is replaced by API calls to backend
    }

    // Sticky animation setup
    function setupStickyAnimation() {
      const progressContainer = document.getElementById('progressContainer');
      const progressPlaceholder = document.getElementById('progressPlaceholder');
      const header = document.querySelector('.header');

      if (!progressContainer || !progressPlaceholder || !header) return;

      // Calculate the offset where sticky should start
      const stickyStart = header.offsetHeight + 20; // Add some margin

      function handleScroll() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const hasScrollbar = document.body.scrollHeight > window.innerHeight;

        if (!hasScrollbar) {
          progressContainer.classList.remove('sticky');
          progressPlaceholder.classList.remove('visible');
          return;
        }

        if (scrollTop >= stickyStart) {
          if (!progressContainer.classList.contains('sticky')) {
            progressContainer.classList.add('sticky');
            progressPlaceholder.classList.add('visible');
          }
        } else {
          if (progressContainer.classList.contains('sticky')) {
            progressContainer.classList.remove('sticky');
            progressPlaceholder.classList.remove('visible');
          }
        }
      }

      // Add scroll listener with throttling
      let ticking = false;
      window.addEventListener('scroll', () => {
        if (!ticking) {
          requestAnimationFrame(() => {
            handleScroll();
            ticking = false;
          });
          ticking = true;
        }
      });

      // Initial check
      handleScroll();
    }

    // Submit individual topic progress to Flask backend via POST
    async function submitTopicProgress(syllabusId, topicId, isCompleted) {
      if (!currentUser || !syllabusId) {
        showStatus('Please sign in and select a syllabus to submit progress.', 'error');
        return;
      }

      try {
        // Prepare data for POST request to Flask backend
        const requestData = {
          student_email: currentUser.email,
          student_name: currentUser.name,
          syllabus_id: syllabusId,
          topic_id: topicId,
          is_completed: isCompleted
        };

        const response = await fetch(`${API_CONFIG.BASE_URL}/update-topic`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(requestData)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
          // Update UI with data from backend
          updateProgressFromBackend({
            topics: result.topics,
            overall_progress: result.overall_progress
          });
          // Show success status briefly
          showStatus('Progress saved!', 'success');
        } else {
          throw new Error(result.error || 'Update failed');
        }
      } catch (error) {
        console.error('Topic update error:', error);
        // Don't show error for every checkbox change to avoid spam
      }
    }

    // Progress is now automatically saved in real-time when checkboxes change

    // Show status message
    function showStatus(message, type) {
      const statusElement = document.getElementById('statusMessage');
      statusElement.textContent = message;
      statusElement.className = 'status-message';
      statusElement.classList.add('status-' + type);

      // Auto-hide success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          statusElement.textContent = '';
          statusElement.className = 'status-message';
        }, 5000);
      }
    }

    // Auto-save progress every 30 seconds (no longer needed as individual topic updates are immediate)
    // setInterval(() => {
    //   if (currentUser) {
    //     saveUserProgress();
    //   }
    // }, 30000);

    // Handle page visibility changes
    document.addEventListener('visibilitychange', function () {
      if (document.visibilityState === 'visible' && currentUser) {
        // Check session validity when page becomes visible again
        const userSession = localStorage.getItem('igcse_user_session');
        if (userSession) {
          try {
            const session = JSON.parse(userSession);
            if (session.expiresAt <= Date.now()) {
              showStatus('Your session has expired. Please sign in again.', 'warning');
              clearUserSession();
              showAuthenticationUI();
            }
          } catch (error) {
            console.error('Error checking session:', error);
          }
        }
      }
    });
  </script>
</body>

</html>