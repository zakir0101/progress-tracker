<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Syllabus Teacher Dashboard</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1400px;
      margin: 20px auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .auth-section {
      background: #e7f3ff;
      padding: 20px;
      border-radius: 8px;
      margin: 20px;
      text-align: center;
      border-left: 4px solid #2c3e50;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .centered {
      margin: 0 auto;
    }

    .auth-section h3 {
      margin-bottom: 15px;
      color: #495057;
    }

    .user-info {
      background: #d4edda;
      padding: 15px 20px;
      border-radius: 8px;
      margin: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 4px solid #28a745;
    }

    .user-details {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #28a745;
    }

    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.2s ease;
    }

    .logout-btn:hover {
      background: #c82333;
    }

    .dashboard-content {
      padding: 30px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .stat-card h3 {
      color: #6c757d;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #2c3e50;
    }

    .stat-change {
      font-size: 0.8rem;
      margin-top: 5px;
    }

    .positive {
      color: #28a745;
    }

    .negative {
      color: #dc3545;
    }

    .students-section {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 30px;
    }

    .section-header {
      background: #495057;
      color: white;
      padding: 15px 20px;
      font-size: 1.2rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-input,
    .filter-select,
    .syllabus-select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
      background: white;
    }

    .students-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .student-card {
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      background: white;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
    }

    .student-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .student-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .student-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: #2c3e50;
    }

    .student-email {
      color: #6c757d;
      font-size: 0.9rem;
      margin-top: 2px;
    }

    .progress-info {
      text-align: right;
    }

    .progress-percentage {
      font-size: 1.5rem;
      font-weight: bold;
      color: #2c3e50;
    }

    .progress-label {
      font-size: 0.8rem;
      color: #6c757d;
    }

    .progress-bar {
      background: #e9ecef;
      border-radius: 25px;
      height: 20px;
      margin: 10px 0;
      overflow: hidden;
    }

    .progress-fill {
      background: linear-gradient(90deg, #28a745, #20c997);
      height: 100%;
      border-radius: 25px;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 0.8rem;
    }

    .student-stats {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 0.9rem;
      color: #6c757d;
    }

    .chart-section {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      margin-top: 30px;
    }

    .chart-container {
      height: 300px;
      margin-top: 20px;
    }

    .hidden {
      display: none;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .status-message {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      text-align: center;
      font-weight: 500;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .export-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.2s ease;
    }

    .export-btn:hover {
      background: #0056b3;
    }

    .assign-syllabus-section {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      margin-top: 30px;
    }

    .assign-syllabus-section h3 {
      margin-bottom: 15px;
      color: #2c3e50;
    }

    .assign-syllabus-form {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: flex-end;
    }

    .assign-syllabus-form div {
      flex: 1;
      min-width: 200px;
    }

    .assign-syllabus-form label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #495057;
    }

    .assign-syllabus-form input[type="email"],
    .assign-syllabus-form select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }

    .assign-syllabus-form button {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s ease;
    }

    .assign-syllabus-form button:hover {
      background: #218838;
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 5px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .dashboard-content {
        padding: 15px;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .students-grid {
        grid-template-columns: 1fr;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .user-info {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }

      .assign-syllabus-form {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Teacher Dashboard</h1>
      <p>Multi-Syllabus Student Progress & Assignments</p>
    </div>

    <!-- Authentication Section -->
    <div class="auth-section" id="authSection">
      <h3>Sign in with Google to access teacher dashboard</h3>
      <div class="centered" id="g_id_onload"
        data-client_id="917775460589-0sb14a7k4rmbdf319evuober7ck655b7.apps.googleusercontent.com" data-context="signin"
        data-ux_mode="popup" data-callback="handleCredentialResponse" data-auto_prompt="false" data-itp_support="true">
      </div>
      <div class="g_id_signin centered" data-type="standard" data-shape="rectangular" data-theme="outline"
        data-text="signin_with" data-size="large" data-logo_alignment="left">
      </div>
      <p style="margin-top: 15px; font-size: 0.9rem; color: #6c757d;">
        <strong>Setup Required:</strong> Replace YOUR_GOOGLE_OAUTH_CLIENT_ID with your actual Google OAuth Client ID
      </p>
    </div>

    <!-- User Info Section -->
    <div class="user-info hidden" id="userInfo">
      <div class="user-details">
        <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
        <div>
          <strong id="userName"></strong>
          <div style="font-size: 0.9rem; color: #6c757d;">
            <span id="userEmail"></span>
          </div>
        </div>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <!-- Dashboard Content (Hidden until authenticated) -->
    <div id="dashboardContent" class="hidden">
      <div class="dashboard-content">
        <!-- Statistics Overview -->
        <div class="dashboard-grid">
          <div class="stat-card">
            <h3>Total Students</h3>
            <div class="stat-value" id="totalStudents">0</div>
            <div class="stat-change positive" id="studentsChange"></div>
          </div>
          <div class="stat-card">
            <h3>Average Progress (Selected Syllabus)</h3>
            <div class="stat-value" id="averageProgress">0%</div>
            <div class="stat-change positive" id="progressChange"></div>
          </div>
          <div class="stat-card">
            <h3>Syllabuses Assigned</h3>
            <div class="stat-value" id="syllabusesAssigned">0</div>
            <div class="stat-change positive" id="assignmentsChange"></div>
          </div>
          <div class="stat-card">
            <h3>Completion Rate (Selected Syllabus)</h3>
            <div class="stat-value" id="completionRate">0%</div>
            <div class="stat-change positive" id="completionChange"></div>
          </div>
        </div>

        <!-- Assign Syllabus Section -->
        <div class="assign-syllabus-section">
          <h3>Assign Syllabus to Student</h3>
          <div id="assignStatusMessage"></div>
          <form class="assign-syllabus-form" onsubmit="assignSyllabus(event)">
            <div>
              <label for="studentEmailSelect">Student:</label>
              <select id="studentEmailSelect" required>
                <option value="">Select a student</option>
              </select>
            </div>
            <div>
              <label for="assignSyllabusSelect">Syllabus to Assign:</label>
              <select id="assignSyllabusSelect" required></select>
            </div>
            <button type="submit">Assign Syllabus</button>
          </form>
        </div>


        <!-- Students Section -->
        <div class="students-section">
          <div class="section-header">
            <span>Student Progress Overview - <span id="currentSyllabusName">All Syllabuses</span></span>
            <div class="controls">
              <select class="syllabus-select" id="viewSyllabusSelect" onchange="filterStudentsBySyllabus()">
                <option value="all">All Syllabuses</option>
              </select>
              <input type="text" class="search-input" id="searchInput" placeholder="Search students..."
                onkeyup="filterStudents()">
              <select class="filter-select" id="progressFilter" onchange="filterStudents()">
                <option value="all">All Progress</option>
                <option value="0-25">0-25%</option>
                <option value="25-50">25-50%</option>
                <option value="50-75">50-75%</option>
                <option value="75-100">75-100%</option>
              </select>
              <button class="export-btn" onclick="exportData()">Export Data</button>
            </div>
          </div>
          <div class="students-grid" id="studentsGrid">
            <!-- Student cards will be dynamically generated here -->
          </div>
        </div>

        <!-- Charts Section -->
        <div class="chart-section">
          <h3>Progress Distribution (Selected Syllabus)</h3>
          <div class="chart-container">
            <canvas id="progressChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="footer"
      style="background: #f8f9fa; padding: 20px; text-align: center; color: #6c757d; border-top: 1px solid #e9ecef;">
      <p>Multi-Syllabus Teacher Dashboard - Real-time student progress monitoring and analytics</p>
      <p><small>Progress data is automatically refreshed</small></p>
    </div>
  </div>

  <script>
    // Unified API Configuration for Flask Backend
    const API_CONFIG = {
      BASE_URL: '/tracker',
      SESSION_TIMEOUT: 60 * 60 * 1000 // 1 hour in milliseconds
    };

    // Global variables
    let currentUser = null;
    let sessionTimer = null;
    let currentSessionId = null;
    let allStudentsProgress = []; // Stores all students progress across all syllabuses
    let allSyllabuses = []; // Stores all available syllabuses
    let displayedStudents = []; // Students currently displayed after filtering
    let progressChart = null;
    let selectedViewSyllabusId = 'all'; // Default to viewing all syllabuses


    // Initialize the application
    document.addEventListener('DOMContentLoaded', function () {
      checkExistingSession();
    });

    // Check for existing user session
    function checkExistingSession() {
      const userSession = localStorage.getItem('igcse_teacher_session');

      if (userSession) {
        try {
          const session = JSON.parse(userSession);
          const now = Date.now();

          // Check if session is still valid
          if (session.expiresAt > now) {
            currentUser = session.user;
            showAuthenticatedUI();
            loadDashboardData();
            startSessionTimer();
            return;
          }
        } catch (error) {
          console.error('Error parsing user session:', error);
        }
        // Clear expired or invalid session
        localStorage.removeItem('igcse_teacher_session');
      }

      showAuthenticationUI();
    }

    // Handle Google OAuth response
    function handleCredentialResponse(response) {
      console.log('Google OAuth response received:', response);

      if (!response || !response.credential) {
        console.error('Invalid OAuth response:', response);
        showStatus('Authentication failed: Invalid response from Google. Please try again.', 'error', 'assignStatusMessage');
        return;
      }

      try {
        // Decode the JWT token to get user info
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        console.log('Decoded JWT payload:', payload);

        currentUser = {
          id: payload.sub,
          name: payload.name,
          email: payload.email,
          picture: payload.picture,
          loginTime: Date.now()
        };

        // Create session with expiration
        const session = {
          user: currentUser,
          expiresAt: Date.now() + API_CONFIG.SESSION_TIMEOUT
        };

        localStorage.setItem('igcse_teacher_session', JSON.stringify(session));

        initializeBackendSession();
        showAuthenticatedUI();
        loadDashboardData();
        startSessionTimer();

        showStatus('Successfully signed in! Loading dashboard...', 'success', 'assignStatusMessage');
      } catch (error) {
        console.error('Authentication error:', error);
        showStatus('Authentication failed: ' + error.message, 'error', 'assignStatusMessage');
      }
    }

    // Initialize session with backend
    async function initializeBackendSession() {
      try {
        currentSessionId = 'teacher_session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      } catch (error) {
        console.error('Session initialization error:', error);
      }
    }

    // Show authentication UI
    function showAuthenticationUI() {
      document.getElementById('authSection').classList.remove('hidden');
      document.getElementById('userInfo').classList.add('hidden');
      document.getElementById('dashboardContent').classList.add('hidden');
    }

    // Show authenticated UI
    function showAuthenticatedUI() {
      if (!currentUser) return;

      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('userInfo').classList.remove('hidden');
      document.getElementById('dashboardContent').classList.remove('hidden');

      // Update user info
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userEmail').textContent = currentUser.email;
      document.getElementById('userAvatar').src = currentUser.picture;
    }

    // Logout function
    function logout() {
      if (confirm('Are you sure you want to log out?')) {
        clearUserSession();
        showAuthenticationUI();
        showStatus('Successfully logged out.', 'success', 'assignStatusMessage');
      }
    }

    // Clear user session
    function clearUserSession() {
      currentUser = null;
      if (sessionTimer) {
        clearTimeout(sessionTimer);
        sessionTimer = null;
      }
      localStorage.removeItem('igcse_teacher_session');
    }

    // Start session timer
    function startSessionTimer() {
      if (sessionTimer) {
        clearTimeout(sessionTimer);
      }

      sessionTimer = setTimeout(() => {
        showStatus('Your session has expired. Please sign in again.', 'warning', 'assignStatusMessage');
        clearUserSession();
        showAuthenticationUI();
      }, API_CONFIG.SESSION_TIMEOUT);
    }

    // Load dashboard data
    async function loadDashboardData() {
      try {
        // Load all syllabuses first
        await loadAllSyllabuses();

        // Load all student progress data from Flask backend
        const progressUrl = `${API_CONFIG.BASE_URL}/all-progress`;
        const progressResponse = await fetch(progressUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });

        if (!progressResponse.ok) {
          throw new Error(`HTTP error! status: ${progressResponse.status}`);
        }

        const progressResult = await progressResponse.json();

        if (progressResult && progressResult.status === 'success' && Array.isArray(progressResult.data)) {
          allStudentsProgress = progressResult.data;
          filterAndRenderStudents();
          // Now that we have student data, populate the student dropdown
          populateStudentDropdown();
        } else {
          throw new Error('Invalid data format received from server for student progress');
        }

      } catch (error) {
        console.error('Error loading dashboard data:', error);
        handleBackendError(error, 'assignStatusMessage');
      }
    }

    async function loadAllSyllabuses() {
      try {
        const syllabusListUrl = `${API_CONFIG.BASE_URL}/all-syllabuses`;
        const response = await fetch(syllabusListUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const result = await response.json();

        if (result.status === 'success' && Array.isArray(result.data)) {
          allSyllabuses = result.data;
          populateSyllabusSelectors();
        } else {
          throw new Error('Invalid data format for syllabuses');
        }

      } catch (error) {
        console.error('Error loading all syllabuses:', error);
        handleBackendError(error, 'assignStatusMessage');
      }
    }

    function populateSyllabusSelectors() {
      const assignSyllabusSelect = document.getElementById('assignSyllabusSelect');
      const viewSyllabusSelect = document.getElementById('viewSyllabusSelect');

      // Clear existing options, keep "All Syllabuses" in view selector
      assignSyllabusSelect.innerHTML = '';
      viewSyllabusSelect.innerHTML = '<option value="all">All Syllabuses</option>';

      allSyllabuses.forEach(syllabus => {
        if (syllabus.id !== 'contact') { // Don't allow assigning the contact syllabus explicitly
          const assignOption = document.createElement('option');
          assignOption.value = syllabus.id;
          assignOption.textContent = syllabus.name + ' (' + syllabus.id + ')';
          assignSyllabusSelect.appendChild(assignOption);
        }

        const viewOption = document.createElement('option');
        viewOption.value = syllabus.id;
        viewOption.textContent = syllabus.name + ' (' + syllabus.id + ')';
        viewSyllabusSelect.appendChild(viewOption);
      });
    }

    function populateStudentDropdown() {
      const studentEmailSelect = document.getElementById('studentEmailSelect');

      // Clear existing options
      studentEmailSelect.innerHTML = '<option value="">Select a student</option>';

      // Populate student dropdown with unique students (only if we have data)
      if (allStudentsProgress && allStudentsProgress.length > 0) {
        const uniqueStudents = [...new Set(allStudentsProgress.map(student => student.email))];
        uniqueStudents.forEach(email => {
          const student = allStudentsProgress.find(s => s.email === email);
          if (student) {
            const option = document.createElement('option');
            option.value = email;
            option.textContent = `${student.name} (${email})`;
            studentEmailSelect.appendChild(option);
          }
        });
      }
    }

    function filterStudentsBySyllabus() {
      selectedViewSyllabusId = document.getElementById('viewSyllabusSelect').value;
      const currentSyllabusNameSpan = document.getElementById('currentSyllabusName');
      if (selectedViewSyllabusId === 'all') {
        currentSyllabusNameSpan.textContent = 'All Syllabuses';
      } else {
        const selectedSyllabus = allSyllabuses.find(s => s.id === selectedViewSyllabusId);
        currentSyllabusNameSpan.textContent = selectedSyllabus ? `${selectedSyllabus.name} (${selectedSyllabus.id})` : 'Unknown Syllabus';
      }
      filterAndRenderStudents();
    }

    // Filter students based on search input and progress filter
    function filterAndRenderStudents() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const progressFilter = document.getElementById('progressFilter').value;

      displayedStudents = allStudentsProgress.filter(student => {
        const studentName = student.name.toLowerCase();
        const studentEmail = student.email.toLowerCase();
        const syllabusName = student.syllabus_name ? student.syllabus_name.toLowerCase() : '';

        // Search filter
        const matchesSearch = studentName.includes(searchTerm) ||
          studentEmail.includes(searchTerm) ||
          syllabusName.includes(searchTerm);

        // Syllabus filter
        const matchesSyllabus = selectedViewSyllabusId === 'all' || student.syllabus_name === allSyllabuses.find(s => s.id === selectedViewSyllabusId)?.name;

        // Progress filter
        let matchesProgress = true;
        if (progressFilter !== 'all') {
          const [min, max] = progressFilter.split('-').map(Number);
          matchesProgress = (student.progress_percentage || 0) >= min && (student.progress_percentage || 0) <= max;
        }

        // Exclude 'contact' syllabus from general view unless specifically selected
        if (selectedViewSyllabusId === 'all' && student.syllabus_name === 'Contact Syllabus') {
          return false;
        }
        if (selectedViewSyllabusId === 'contact' && student.syllabus_name !== 'Contact Syllabus') {
            return false; // Only show contact syllabus if selected
        }

        return matchesSearch && matchesSyllabus && matchesProgress;
      });

      updateStatistics();
      renderStudentCards();
      renderProgressChart();
    }


    // Update statistics based on displayed students
    function updateStatistics() {
      const totalStudents = new Set(displayedStudents.map(s => s.email)).size; // Unique students
      const studentsWithProgress = displayedStudents.filter(student => student.progress_percentage > 0);
      const averageProgress = studentsWithProgress.length > 0
        ? Math.round(studentsWithProgress.reduce((sum, student) => sum + student.progress_percentage, 0) / studentsWithProgress.length)
        : 0;
      const syllabusesAssigned = new Set(displayedStudents.map(s => s.syllabus_name)).size; // Unique syllabuses displayed
      const completionRate = totalStudents > 0
        ? Math.round((studentsWithProgress.length / totalStudents) * 100)
        : 0;

      document.getElementById('totalStudents').textContent = totalStudents;
      document.getElementById('averageProgress').textContent = averageProgress + '%';
      document.getElementById('syllabusesAssigned').textContent = syllabusesAssigned;
      document.getElementById('completionRate').textContent = completionRate + '%';

      // Clear change indicators for simplicity or implement actual tracking if needed
      document.getElementById('studentsChange').textContent = '';
      document.getElementById('progressChange').textContent = '';
      document.getElementById('assignmentsChange').textContent = '';
      document.getElementById('completionChange').textContent = '';
    }

    // Render student cards based on displayed students
    function renderStudentCards() {
      const studentsGrid = document.getElementById('studentsGrid');
      studentsGrid.innerHTML = '';

      if (displayedStudents.length === 0) {
        studentsGrid.innerHTML = '<p style="text-align: center; grid-column: 1 / -1;">No students found matching current filters.</p>';
        return;
      }

      displayedStudents.forEach(student => {
        const card = document.createElement('div');
        card.className = 'student-card';
        card.innerHTML = `
                    <div class="student-header">
                        <div>
                            <div class="student-name">${student.name}</div>
                            <div class="student-email">${student.email}</div>
                            <div class="progress-label" style="margin-top: 5px;">Syllabus: ${student.syllabus_name || 'N/A'}</div>
                        </div>
                        <div class="progress-info">
                            <div class="progress-percentage">${Math.round(student.progress_percentage || 0)}%</div>
                            <div class="progress-label">Progress</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${student.progress_percentage || 0}% ">${Math.round(student.progress_percentage || 0)}%</div>
                    </div>
                    <div class="student-stats">
                        <span>Completed: ${student.completed_count || 0}/${student.total_topics || 0}</span>
                        <span>Last Updated: ${student.last_updated ? new Date(student.last_updated).toLocaleDateString() : 'Never'}</span>
                    </div>
                `;
        studentsGrid.appendChild(card);
      });
    }

    // Render progress chart based on displayed students
    function renderProgressChart() {
      const ctx = document.getElementById('progressChart').getContext('2d');

      if (progressChart) {
        progressChart.destroy();
      }

      const progressRanges = {
        '0-25': 0,
        '25-50': 0,
        '50-75': 0,
        '75-100': 0
      };

      displayedStudents.forEach(student => {
        const progress = student.progress_percentage || 0;
        if (progress <= 25) progressRanges['0-25']++;
        else if (progress <= 50) progressRanges['25-50']++;
        else if (progress <= 75) progressRanges['50-75']++;
        else progressRanges['75-100']++;
      });

      progressChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['0-25%', '25-50%', '50-75%', '75-100%'],
          datasets: [{
            label: 'Number of Students',
            data: [progressRanges['0-25'], progressRanges['25-50'], progressRanges['50-75'], progressRanges['75-100']],
            backgroundColor: [
              '#dc3545',
              '#ffc107',
              '#17a2b8',
              '#28a745'
            ],
            borderColor: [
              '#c82333',
              '#e0a800',
              '#138496',
              '#1e7e34'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number of Students'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Progress Range'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Student Progress Distribution'
            }
          }
        }
      });
    }

    // Filter students (combined search and progress filter)
    function filterStudents() {
      filterAndRenderStudents();
    }

    // Assign syllabus to a student
    async function assignSyllabus(event) {
      event.preventDefault();
      const studentEmail = document.getElementById('studentEmailSelect').value;
      const syllabusId = document.getElementById('assignSyllabusSelect').value;

      if (!studentEmail || !syllabusId) {
        showStatus('Please enter student email and select a syllabus.', 'error', 'assignStatusMessage');
        return;
      }

      try {
        const response = await fetch(`${API_CONFIG.BASE_URL}/assign-syllabus`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            student_email: studentEmail,
            syllabus_id: syllabusId
          })
        });

        const result = await response.json();

        if (result.success) {
          showStatus(result.message, 'success', 'assignStatusMessage');
          // Reset the form
          document.getElementById('studentEmailSelect').value = '';
          document.getElementById('assignSyllabusSelect').selectedIndex = 0;
          loadDashboardData(); // Refresh data
        } else {
          throw new Error(result.error || 'Assignment failed');
        }

      } catch (error) {
        console.error('Syllabus assignment error:', error);
        showStatus('Failed to assign syllabus: ' + error.message, 'error', 'assignStatusMessage');
      }
    }

    // Export data
    function exportData() {
      try {
        const csvContent = generateCSV();
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);

        link.setAttribute('href', url);
        link.setAttribute('download', `teacher_dashboard_progress_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showStatus('Data exported successfully!', 'success', 'assignStatusMessage');
      } catch (error) {
        console.error('Export error:', error);
        showStatus('Failed to export data.', 'error', 'assignStatusMessage');
      }
    }

    // Generate CSV content from currently displayed students
    function generateCSV() {
      const headers = ['Student Name', 'Student Email', 'Syllabus', 'Progress %', 'Completed Topics', 'Total Topics', 'Last Updated'];
      const rows = displayedStudents.map(student => [
        student.name,
        student.email,
        student.syllabus_name || 'N/A',
        Math.round(student.progress_percentage || 0),
        student.completed_count || 0,
        student.total_topics || 0,
        student.last_updated ? new Date(student.last_updated).toLocaleString() : 'Never'
      ]);

      return [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');
    }

    // Show status message
    function showStatus(message, type, targetElementId = 'assignStatusMessage') {
      let statusElement = document.getElementById(targetElementId);
      if (!statusElement) {
        statusElement = document.createElement('div');
        statusElement.id = targetElementId;
        statusElement.className = 'status-message';
        document.querySelector('.dashboard-content').prepend(statusElement);
      }

      statusElement.textContent = message;
      statusElement.className = 'status-message';
      statusElement.classList.add('status-' + type);

      if (type === 'success') {
        setTimeout(() => {
          statusElement.textContent = '';
          statusElement.className = 'status-message';
        }, 5000);
      }
    }

    // Handle backend connection errors
    function handleBackendError(error, targetElementId = 'assignStatusMessage') {
      console.error('Backend connection error:', error);
      if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
        showStatus('Cannot connect to backend server. Please ensure the Flask server is running.', 'error', targetElementId);
      } else {
        showStatus('Backend error: ' + error.message, 'error', targetElementId);
      }
    }

    // Auto-refresh data every 5 minutes
    setInterval(() => {
      if (currentUser) {
        loadDashboardData();
      }
    }, 5 * 60 * 1000);
  </script>
</body>

</html>